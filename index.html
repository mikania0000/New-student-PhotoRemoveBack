<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±åƒç·¨è¼¯å™¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Raleway&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Raleway', sans-serif;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #06c59c;
            padding: 20px;
        }

        .outer-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 880px;
            width: 100%;
            position: relative;
        }

        h1 { margin-bottom: 20px; text-align: center; white-space: nowrap; }

        .container { display: flex; flex-direction: row; align-items: flex-start; }

        .controls { margin-left: -145px; display: flex; flex-direction: column; }

        .control-group, .horizontal-group { display: flex; align-items: center; margin-bottom: 20px; }

        .horizontal-group {
            display: flex; align-items: center; justify-content: flex-start; gap: 40px; margin-bottom: 20px; margin-left: 60px;
        }

        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper button { background-color: #6c757d; color: white; }
        .file-input-wrapper input[type="file"] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        label { margin-right: 10px; font-weight: bold; width: 100px; text-align: right; font-size: 20px; }

        input[type="range"], input[type="text"] { width: 250px; margin-right: 10px; font-size: 20px; }

        button {
            padding: 10px 20px; font-size: 20px; cursor: pointer; border: none; border-radius: 5px; color: white; background-color: #007bff; width: auto; white-space: nowrap; transition: 0.2s;
        }

        button.clear { background-color: #dc3545; }
        button.crop { background-color: #28a745; }
        button.remove-bg { background-color: #dc3545; }
        button.undo { background-color: #6c757d; }
        button.copy { background-color: #ff69b4; color: white; }
        button.save { background-color: #ffc107; color: black; }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666;}

        #canvas { border: 1px solid black; width: 264px; height: 330px; background-color: white; margin-bottom: 20px; }

        .bottom-buttons { display: flex; justify-content: center; margin-top: 20px; gap: 20px; }

        .file-name { text-align: center; margin-top: 10px; font-style: italic; }

        /* æ–°å¢åº•éƒ¨ç‹€æ…‹é¢æ¿çš„ CSS */
        .status-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .status-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            background-color: #ccc;
        }

        .light-green { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
        .light-red { background-color: #dc3545; box-shadow: 0 0 8px #dc3545; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .btn-clear-folder { background-color: #dc3545; font-size: 14px; padding: 6px 12px; margin-left: 15px;}

        @media (max-width: 870px) {
            .container { flex-direction: column; }
            #canvas { width: 200px; height: 250px; }
            .controls { margin-left: 0; width: 100%; margin-top: 20px;}
            .horizontal-group { margin-left: 0; justify-content: center; flex-wrap: wrap; gap: 15px;}
            input[type="range"], input[type="text"] { width: 100%; margin-bottom: 10px;}
            .status-panel { flex-direction: column; gap: 15px; text-align: center;}
        }

        .floating-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: #333; color: #fff; padding: 20px 32px; font-size: 28px;
            border-radius: 12px; z-index: 9999; opacity: 0.95;
            animation: fadeOut 0.4s ease-in-out 2.6s forwards;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .floating-msg.success { background-color: #28a745; }
        .floating-msg.error { background-color: #dc3545; }
        .floating-msg.info { background-color: #007bff; }

        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>
    <div class="outer-container">
        <h1>å½±åƒç·¨è¼¯å™¨</h1>
        <div class="container">
            <div>
                <canvas id="canvas"></canvas>
                <div class="bottom-buttons">
                    <div class="file-input-wrapper">
                        <button>æœ¬æ©ŸåŒ¯å…¥</button>
                        <input type="file" id="imageUpload" accept="image/*">
                    </div>
                    <button class="clear" id="clearBtn">æ¸…ç©ºç…§ç‰‡</button>
                    <button class="save" id="saveBtn">é›²ç«¯å„²å­˜åŠè¤‡è£½</button>
                </div>
                <div class="file-name" id="fileName"></div>
            </div>
            <div class="controls">
                <div class="horizontal-group">
                    <button class="crop" id="cropBtn">è£åˆ‡</button>
                    <button class="remove-bg" id="removeBgBtn">å»èƒŒ</button>
                    <button class="undo" id="undoBtn">å¾©åŸ</button>
                </div>
                <div class="control-group">
                    <label for="brightness">äº® Â  Â  Â åº¦ï¼š</label>
                    <input type="range" id="brightness" min="-100" max="100" value="0">
                </div>
                <div class="control-group">
                    <label for="contrast">å° Â  Â  Â æ¯”ï¼š</label>
                    <input type="range" id="contrast" min="-100" max="100" value="0">
                </div>
                <div class="control-group">
                    <label for="saturation">é£½ Â å’Œ Â åº¦ï¼š</label>
                    <input type="range" id="saturation" min="-100" max="100" value="0">
                </div>
                <div class="control-group">
                    <label for="driveLink">ä¸‹è¼‰ç¶²å€ï¼š</label>
                    <input type="text" id="driveLink" placeholder="è²¼ä¸Š Google Drive é€£çµ">
                    <button id="loadFromDriveBtn">é›²ç«¯è¼‰å…¥ç…§ç‰‡</button>
                </div>
                <div class="control-group">
                    <label for="newImageURL">å„²å­˜ç¶²å€ï¼š</label>
                    <input type="text" id="newImageURL" readonly>
                    <button id="copyBtn" class="copy">è¤‡è£½é›²ç«¯ç¶²å€</button>
                </div>
            </div>
        </div>
        
        <!-- æ–°ç‰ˆåº•éƒ¨è³‡è¨Šé¢æ¿ï¼šåŒ…å«å»èƒŒæ¬¡æ•¸èˆ‡è³‡æ–™å¤¾ç‡ˆè™Ÿ -->
        <div class="status-panel">
            <div>å»èƒŒå‰©é¤˜æ¬¡æ•¸: <span id="callsCount" style="color: #007bff;">è¼‰å…¥ä¸­...</span></div>
            <div>
                <span class="status-light" id="folderLight"></span>
                ç…§ç‰‡è³‡æ–™å¤¾: <span id="folderCount">æŸ¥è©¢ä¸­...</span> æª”æ¡ˆ
                <button id="clearFolderBtn" class="btn-clear-folder">æ¸…ç†æª”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script>
        // === èˆ‡ Google Apps Script é€šè¨Šçš„ API è¨­å®š ===
        // é€™æ˜¯ä½ å‰›å‰›æä¾›çš„æœ€æ–°éƒ¨ç½²ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbyYitqpGzrgBSE95doTnUSJbfD1dQvm_AftHbQWmdG4cW3XTtrSaDUTzZZDWYAyNDx8aQ/exec";

        // å…±ç”¨çš„ API å‘¼å«å‡½æ•¸ï¼Œè§£æ±º CORS å•é¡Œ
        async function fetchAPI(action, params = {}, method = 'GET') {
            try {
                if (method === 'GET') {
                    const query = new URLSearchParams({ action, ...params }).toString();
                    const res = await fetch(`${API_URL}?${query}`);
                    return await res.json();
                } else {
                    // POST ä½¿ç”¨ text/plain é¿å… GAS çš„ CORS preflight å¤±æ•—
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action, ...params })
                    });
                    return await res.json();
                }
            } catch (error) {
                console.error("API éŒ¯èª¤:", error);
                throw error;
            }
        }

        let canvas, img = null, originalFileName = '', originalImageData = null;
        let history = [], sliderState = { brightness: 0, contrast: 0, saturation: 0 };

        document.addEventListener('DOMContentLoaded', () => {
            canvas = new fabric.Canvas('canvas', {
                width: 264, height: 330, selection: false, backgroundColor: 'white'
            });

            // åˆå§‹åŒ–è¼‰å…¥å‰©é¤˜æ¬¡æ•¸èˆ‡è³‡æ–™å¤¾ç‹€æ…‹
            refreshAPICount();
            updateFolderStatus();

            canvas.on('mouse:wheel', function(opt) {
                if (img) {
                    let zoom = img.scaleX * (opt.e.deltaY > 0 ? 0.95 : 1.05);
                    zoom = Math.max(0.02, Math.min(zoom, 10));
                    img.scale(zoom);
                    canvas.renderAll();
                    opt.e.preventDefault();
                    opt.e.stopPropagation();
                }
            });
        });

        // --- API æ›´æ–°åŠŸèƒ½ ---
        async function refreshAPICount() {
            try {
                const count = await fetchAPI('getRemainingCalls');
                document.getElementById('callsCount').textContent = count !== undefined ? count : "éŒ¯èª¤";
            } catch(e) { document.getElementById('callsCount').textContent = "é€£ç·šå¤±æ•—"; }
        }

        async function updateFolderStatus() {
            const light = document.getElementById('folderLight');
            const countText = document.getElementById('folderCount');
            light.className = 'status-light'; // reset
            countText.textContent = 'æŸ¥è©¢ä¸­...';

            try {
                const res = await fetchAPI('checkFolderStatus');
                countText.textContent = res.count;
                
                // æª”æ¡ˆæ•¸é‡å¤§æ–¼ 0 (å­˜åœ¨æª”æ¡ˆ) äº®ç¶ ç‡ˆï¼Œç­‰æ–¼ 0 (ä¸å­˜åœ¨æª”æ¡ˆ) äº®ç´…ç‡ˆ
                if(res.count > 0) {
                    light.classList.add('light-green');
                } else {
                    light.classList.add('light-red');
                }
            } catch (e) {
                countText.textContent = 'éŒ¯èª¤';
            }
        }

        // --- UI å·¥å…· ---
        function showFloatingMsg(message, type = "info") {
            const div = document.createElement("div");
            div.className = `floating-msg ${type}`;
            div.innerHTML = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), type === "success" ? 2000 : 3000);
            return div; // ç‚ºäº†é€²åº¦æ¢èƒ½å›å‚³æ“ä½œ
        }

        function saveState() {
            history.push({ json: canvas.toJSON(), sliderState: { ...sliderState } });
        }

        function undoLastAction() {
            if (history.length > 0) {
                const lastState = history.pop();
                canvas.loadFromJSON(lastState.json, () => {
                    canvas.renderAll();
                    img = canvas.getObjects().find(obj => obj.type === 'image');
                    updateSliders(lastState.sliderState);
                });
            }
        }

        function resetSliders() {
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 0;
            document.getElementById('saturation').value = 0;
            sliderState = { brightness: 0, contrast: 0, saturation: 0 };
        }

        function updateSliders(state) {
            document.getElementById('brightness').value = state.brightness;
            document.getElementById('contrast').value = state.contrast;
            document.getElementById('saturation').value = state.saturation;
            sliderState = { ...state };
        }

        function resetAll() {
            resetSliders();
            document.getElementById('newImageURL').value = '';
            history = [];
        }

        // --- æœ¬æ©Ÿä¸Šå‚³ ---
        document.getElementById('imageUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            originalFileName = file.name;
            document.getElementById('fileName').textContent = `æª”æ¡ˆåç¨±: ${originalFileName}`;

            const reader = new FileReader();
            reader.onload = (e) => {
                canvas.clear();
                fabric.Image.fromURL(e.target.result, function(oImg) {
                    img = oImg;
                    img.set({
                        left: canvas.width / 2, top: canvas.height / 2,
                        originX: 'center', originY: 'center',
                        selectable: true, hasControls: true, hasBorders: true, lockScalingFlip: true
                    });
                    canvas.add(img);
                    canvas.renderAll();
                    resetSliders();
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(file);
        });

        // --- æ¿¾é¡èˆ‡æ§åˆ¶ ---
        document.getElementById('clearBtn').addEventListener('click', () => {
            canvas.clear(); img = null; originalFileName = '';
            document.getElementById('imageUpload').value = '';
            document.getElementById('fileName').textContent = '';
            resetAll();
        });

        function adjustImage() {
            if (!img) return;
            const b = parseInt(document.getElementById('brightness').value);
            const c = parseInt(document.getElementById('contrast').value);
            const s = parseInt(document.getElementById('saturation').value);

            img.filters = [
                new fabric.Image.filters.Brightness({ brightness: b / 100 }),
                new fabric.Image.filters.Contrast({ contrast: c / 100 }),
                new fabric.Image.filters.Saturation({ saturation: s / 100 })
            ];
            img.applyFilters();
            canvas.renderAll();
            sliderState = { brightness: b, contrast: c, saturation: s };
        }

        ['brightness', 'contrast', 'saturation'].forEach(id => 
            document.getElementById(id).addEventListener('input', adjustImage)
        );

        document.getElementById('cropBtn').addEventListener('click', () => {
            if (!img) return;
            saveState();
            const matrix = img.calcTransformMatrix();
            const croppingCanvas = document.createElement('canvas');
            croppingCanvas.width = canvas.width; croppingCanvas.height = canvas.height;
            const ctx = croppingCanvas.getContext('2d');

            ctx.setTransform(...matrix);
            ctx.drawImage(img._element, -img.width / 2, -img.height / 2, img.width, img.height);

            fabric.Image.fromURL(croppingCanvas.toDataURL('image/png'), function(croppedImg) {
                canvas.clear();
                croppedImg.set({
                    left: canvas.width / 2, top: canvas.height / 2,
                    originX: 'center', originY: 'center',
                    selectable: true, hasControls: true, hasBorders: true, lockScalingFlip: true
                });
                canvas.add(croppedImg);
                img = croppedImg;
                canvas.renderAll();
                resetSliders();
            });
        });

        document.getElementById('undoBtn').addEventListener('click', () => {
            undoLastAction();
            resetAll();
            showFloatingMsg('â†©ï¸ å·²å¾©åŸè‡³ä¸Šä¸€æ­¥ç‹€æ…‹', 'info');
        });

        // --- å»èƒŒåŠŸèƒ½ ---
        document.getElementById('removeBgBtn').addEventListener('click', async () => {
            if (!img) { showFloatingMsg('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡å†å»èƒŒ', 'info'); return; }
            
            showFloatingMsg('ğŸ“¡ å–å¾—æ¬Šæ–ä¸­...', 'info');
            try {
                const apiResponse = await fetchAPI('getAPIKey');
                if (apiResponse.apiKey) {
                    saveState();
                    await performRemoveBackground(apiResponse.apiKey, apiResponse.row);
                } else {
                    showFloatingMsg(`âŒ ${apiResponse.message}`, 'error');
                }
            } catch (err) {
                showFloatingMsg('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•å–å¾—æ¬Šæ–', 'error');
            }
        });

        async function performRemoveBackground(apiKey, row) {
            const dataURL = canvas.toDataURL('image/jpeg');
            try {
                const msg = showFloatingMsg('ğŸ“¡ å»èƒŒè™•ç†ä¸­...');
                const blob = await (await fetch(dataURL)).blob();
                const formData = new FormData();
                formData.append('image_file', blob, 'image.jpg');
                formData.append('size', 'auto');

                const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST', headers: { 'X-Api-Key': apiKey }, body: formData
                });

                if (response.ok) {
                    const resultUrl = URL.createObjectURL(await response.blob());
                    fabric.Image.fromURL(resultUrl, async function(newImg) {
                        canvas.clear();
                        newImg.set({
                            left: canvas.width / 2, top: canvas.height / 2,
                            originX: 'center', originY: 'center', selectable: true, hasControls: true, lockScalingFlip: true
                        });
                        const whiteBg = new fabric.Rect({
                            left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                            width: newImg.width, height: newImg.height, fill: 'white'
                        });
                        canvas.add(whiteBg); canvas.add(newImg); canvas.renderAll();
                        img = newImg; resetSliders();

                        // æ‰£é™¤é»æ•¸ä¸¦æ›´æ–°ç•«é¢
                        fetchAPI('updateAPIKeyUsage', { row }, 'POST');
                        setTimeout(refreshAPICount, 2000); 
                        msg.remove();
                        showFloatingMsg('âœ… å·²å®Œæˆå»èƒŒï¼', 'success');
                    });
                } else {
                    msg.remove();
                    showFloatingMsg('âŒ å»èƒŒå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
                }
            } catch (error) {
                showFloatingMsg('âŒ å»èƒŒéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
            }
        }

        // --- å„²å­˜èˆ‡è¼‰å…¥ (GAS ä¸²æ¥) ---
        document.getElementById('saveBtn').addEventListener('click', async () => {
            let fileName = originalFileName ? originalFileName.trim() : '';
            if (!fileName) return showFloatingMsg('âŒ ç„¡æ³•ä¿å­˜ï¼Œæ²’æœ‰æª”æ¡ˆåç¨±ã€‚', 'error');

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            let percent = 0;
            const progressDiv = showFloatingMsg(`ğŸ“¡ è™•ç†ä¸­...${percent}%`, 'info');
            
            const interval = setInterval(() => {
                percent = Math.min(percent + Math.floor(Math.random() * 10) + 5, 95);
                progressDiv.innerHTML = `ğŸ“¡ å„²å­˜ä¸­...${percent}%`;
            }, 200);

            try {
                const dataURL = canvas.toDataURL({ format: 'jpeg', quality: 0.8 });
                const res = await fetchAPI('saveEditedImage', { dataURL, originalFileName: fileName }, 'POST');
                
                clearInterval(interval);
                progressDiv.remove();
                btn.disabled = false;

                if (res.url) {
                    document.getElementById('newImageURL').value = res.url;
                    navigator.clipboard.writeText(res.url).catch(()=>{});
                    showFloatingMsg('âœ… å·²å„²å­˜ä¸¦è¤‡è£½é›²ç«¯ç¶²å€ï¼', 'success');
                    updateFolderStatus(); // å„²å­˜å¾Œæ›´æ–°è³‡æ–™å¤¾æª”æ¡ˆæ•¸
                } else {
                    showFloatingMsg('âŒ å„²å­˜å¤±æ•—ã€‚', 'error');
                }
            } catch(e) {
                clearInterval(interval); progressDiv.remove(); btn.disabled = false;
                showFloatingMsg('âŒ å„²å­˜ç™¼ç”ŸéŒ¯èª¤ã€‚', 'error');
            }
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            const url = document.getElementById('newImageURL').value;
            if (!url) return showFloatingMsg('âš ï¸ æ²’æœ‰å¯è¤‡è£½çš„ç¶²å€', 'info');
            navigator.clipboard.writeText(url).then(() => showFloatingMsg('âœ… é›²ç«¯ç¶²å€å·²è¤‡è£½ï¼', 'success'))
                .catch(() => showFloatingMsg('âŒ è¤‡è£½å¤±æ•—', 'error'));
        });

        document.getElementById('loadFromDriveBtn').addEventListener('click', async () => {
            const driveLink = document.getElementById('driveLink').value;
            const fileIdMatch = driveLink.match(/[-\w]{25,}/);
            if (!fileIdMatch) return showFloatingMsg('âš ï¸ ç„¡æ³•è§£æ Drive é€£çµã€‚', 'info');

            const btn = document.getElementById('loadFromDriveBtn');
            btn.disabled = true;
            const msg = showFloatingMsg('ğŸ“¡ ä¸‹è¼‰ä¸­...', 'info');

            try {
                const res = await fetchAPI('getDriveImageBase64', { fileId: fileIdMatch[0] });
                msg.remove();
                btn.disabled = false;

                if (res.error) {
                    showFloatingMsg(`âŒ ${res.error}`, 'error');
                } else {
                    originalFileName = res.fileName;
                    fabric.Image.fromURL(res.base64Image, function(oImg) {
                        img = oImg;
                        img.set({
                            left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                            selectable: true, hasControls: true, hasBorders: true, lockScalingFlip: true
                        });
                        canvas.clear(); canvas.add(img); canvas.renderAll();
                        resetSliders();
                        document.getElementById('fileName').textContent = `æª”æ¡ˆåç¨±: ${originalFileName}`;
                        document.getElementById('driveLink').value = '';
                        showFloatingMsg('âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼', 'success');
                    });
                }
            } catch(e) {
                msg.remove(); btn.disabled = false;
                showFloatingMsg('âŒ ç¶²è·¯ç•°å¸¸ï¼Œç„¡æ³•è¼‰å…¥ã€‚', 'error');
            }
        });

        // --- è³‡æ–™å¤¾æ¸…ç† ---
        document.getElementById('clearFolderBtn').addEventListener('click', async () => {
            if(!confirm("é€™æœƒå°‡ã€Œç…§ç‰‡ã€è³‡æ–™å¤¾å…§çš„æ‰€æœ‰æª”æ¡ˆç§»è‡³åƒåœ¾æ¡¶ (ä¸æœƒåˆªé™¤å­è³‡æ–™å¤¾)ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            
            const btn = document.getElementById('clearFolderBtn');
            btn.disabled = true;
            btn.textContent = "æ¸…ç†ä¸­...";

            try {
                const res = await fetchAPI('clearFolderFiles', {}, 'POST');
                if(res.success) {
                    showFloatingMsg(`âœ… æˆåŠŸæ¸…ç†äº† ${res.count} å€‹æª”æ¡ˆï¼`, 'success');
                } else {
                    showFloatingMsg('âŒ æ¸…ç†å¤±æ•—', 'error');
                }
            } catch (e) {
                showFloatingMsg('âŒ æ¸…ç†æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = "æ¸…ç†æª”æ¡ˆ";
                updateFolderStatus(); // é‡æ–°è®€å–ç‹€æ…‹
            }
        });

    </script>
</body>
</html>